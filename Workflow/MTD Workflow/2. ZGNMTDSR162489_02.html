
<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Mermaid Diagram</title>
  <script type="module">
    import mermaid from 'https://cdn.jsdelivr.net/npm/mermaid@10/dist/mermaid.esm.min.mjs';
    mermaid.initialize({ startOnLoad: true });
  </script>
</head>
<body>
  <div class="mermaid">
    flowchart TD
    %% Node Definitions
    A("Start")
    B{"Current T-code is 'MB1B'?"}
    C["Inspect call stack for 'SAPLMBWL' and 'IMSEG'"]
    D{"Call stack analysis successful?"}
    E["Set context flag lv_flag = 'X'"]
    F{"Is context flag lv_flag = 'X'?"}
    G[/"Access goods movement item data"/]
    H{"Data access successful?"}
    I{"User action is 'Check' (OK_CHECK)?"}
    J[/"Query QMAT for inspection type '08' or 'Z01'"/]
    K{"Material configured for '08' or 'Z01'?"}
    L{"Insp. Type is ('08' or 'Z01') AND Mvmt Type is ('101', '322', '349', 'Z49')?"}
    M{"Movement Type is '101'?"}
    N[/"PATH A: Query custom table ZGMTD_CLD_PGI"/]
    O[/"PATH B: Search QALS for previous inspection lot of type '04'"/]
    P{"Type '04' lot found?"}
    Q[/"Search QALS for previous lot of type '08' or 'Z01'"/]
    R{"PGI records found from ZGMTD_CLD_PGI?"}
    S["Loop Start: For each PGI record"]
    T["Convert timestamp (hours) to seconds"]
    U["Convert lot start date/time to combined timestamp"]
    V["Add seconds to start timestamp for new end timestamp"]
    W["Convert new end timestamp back to date and time"]
    X["Overwrite inspection lot end date/time"]
    Y["Loop End"]
    Z{"Previous inspection lots found in QALS?"}
    AA["Sort found lots by end date (descending)"]
    AB["Read first record (latest lot)"]
    AC["Compare latest end date with current system date"]
    AD{"Is latest end date > system date?"}
    AE["Set new lot end date = latest end date"]
    AF["Set new lot end date = system date"]
    AG[/"Pass modified inspection lot to e_qals"/]
    AH["Set e_active flag to 'X'"]
    END_NODE([End])

    %% Connections
    A --> B
    B -- "Yes, logic skipped" --> END_NODE
    B -- "No" --> C
    C --> D
    D -- "Yes, successful" --> E
    D -- "No, unsuccessful" --> F
    E --> F
    F -- "Yes, flag is set" --> G
    F -- "No, flag not set" --> END_NODE
    G --> H
    H -- "Yes, successful" --> I
    H -- "No, data access failed" --> END_NODE
    I -- "Yes, action is 'Check'" --> END_NODE
    I -- "No, action is 'Post' or 'Save'" --> J
    J --> K
    K -- "Yes, material is configured" --> L
    K -- "No, not configured" --> END_NODE
    L -- "Yes, core conditions met" --> M
    L -- "No, core conditions not met" --> END_NODE
    M -- "Yes, Path A" --> N
    M -- "No, Path B" --> O
    N --> R
    O --> P
    P -- "Yes, '04' lot found" --> Z
    P -- "No, '04' lot not found" --> Q
    Q --> Z
    R -- "Yes, PGI records found" --> S
    R -- "No, no PGI records found" --> AG
    S --> T
    T --> U
    U --> V
    V --> W
    W --> X
    X --> Y
    Y -- "More records" --> S
    Y -- "No more records" --> AG
    Z -- "Yes, previous lots found" --> AA
    Z -- "No, no previous lots found" --> AG
    AA --> AB
    AB --> AC
    AC --> AD
    AD -- "Yes" --> AE
    AD -- "No" --> AF
    AE --> AG
    AF --> AG
    AG --> AH
    AH --> END_NODE
  </div>
</body>
</html>
